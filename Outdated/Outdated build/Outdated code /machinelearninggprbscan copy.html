<!DOCTYPE html>
<html>
<head>
    <title>Teachable Machine Image Upload Model</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #uploaded-image { 
            border: 2px solid #ddd; 
            margin-top: 15px;
            max-width: 100%; /* Ensure image scales down */
            height: auto;
        }
        #label-container div {
            padding: 5px;
            margin-top: 5px;
            border-bottom: 1px solid #eee;
        }
        .header { margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Teachable Machine Image Model (Upload Photo)</h2>
        <p>Step 1: Click "Load Model". Step 2: Upload a photo.</p>
    </div>

    <button type="button" onclick="init()">Load Model</button>

    <br><br>

    <input type="file" id="file-input" accept="image/*" onchange="loadFile(event)" style="display: none;">
    <span id="upload-status" style="color: grey;">(Click Load Model first)</span>

    <div id="image-container">
        <img id="uploaded-image" style="max-width: 300px; max-height: 300px; display: none;" alt="Uploaded Image">
    </div>

    <h3>Prediction Results:</h3>
    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        // **IMPORTANT:** Replace this URL with your Teachable Machine Model URL
        const URL = "https://teachablemachine.withgoogle.com/models/hUnK7-t8o/"; 
        
        let model, labelContainer, maxPredictions;
        const imageElement = document.getElementById("uploaded-image");

        /**
         * Loads the Teachable Machine model and sets up the environment.
         */
        async function init() {
            const uploadInput = document.getElementById("file-input");
            const uploadStatus = document.getElementById("upload-status");

            uploadStatus.textContent = "Loading model...";
            
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                // Load the model
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // Setup the label container
                labelContainer = document.getElementById("label-container");
                labelContainer.innerHTML = ''; 
                for (let i = 0; i < maxPredictions; i++) {
                    labelContainer.appendChild(document.createElement("div"));
                }
                
                // Enable file upload after successful model load
                uploadInput.style.display = 'inline-block';
                uploadStatus.textContent = "Model loaded. Please upload a photo.";
                document.querySelector("button").disabled = true; // Disable the load button
                
                console.log("âœ… Model loaded successfully and UI updated.");

            } catch (error) {
                uploadStatus.textContent = "ERROR: Failed to load model. Check console.";
                console.error("ðŸ”´ ERROR: Failed to load model from URL.", error);
            }
        }

        /**
         * Handles the file selection, displays the image, and triggers prediction.
         */
        function loadFile(event) {
            if (!model) {
                alert("Please click 'Load Model' first.");
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            // 1. Display the uploaded image
            imageElement.src = URL.createObjectURL(file);
            imageElement.style.display = 'block';

            // 2. Wait for the image to load, then predict
            // This is crucial, as the prediction needs the image data to be ready.
            imageElement.onload = function() {
                predictImage();
            };
        }

        /**
         * Runs the displayed image through the model and updates the labels.
         */
        async function predictImage() {
            if (!model || imageElement.style.display === 'none' || !imageElement.src) {
                console.error("Prediction cancelled: Model or image not ready.");
                return;
            }

            try {
                // Run prediction using the loaded HTMLImageElement
                const prediction = await model.predict(imageElement);

                // Update the DOM with the results
                for (let i = 0; i < maxPredictions; i++) {
                    const classPrediction =
                        `${prediction[i].className}: ${prediction[i].probability.toFixed(2)}`;
                    labelContainer.childNodes[i].innerHTML = classPrediction;
                }
                console.log("Prediction complete and results displayed.");

            } catch (error) {
                console.error("ðŸ”´ ERROR during prediction:", error);
                document.getElementById("label-container").innerHTML = `<div>Prediction Failed! Check Console.</div>`;
            }
        }
    </script>

</body>
</html>